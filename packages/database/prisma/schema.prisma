// packages/database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserPlan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

enum DetectionVerdict {
  LIKELY_AI
  MIXED
  LIKELY_HUMAN
  HIGHLY_HUMAN
}

model User {
  id                    String    @id @default(cuid())
  clerkId               String    @unique
  email                 String?
  plan                  UserPlan  @default(FREE)

  // API access
  apiKey                String?   @unique

  // Usage tracking
  detectionCount        Int       @default(0)
  verificationCount     Int       @default(0)
  monthlyDetectionCount Int       @default(0)
  monthlyResetAt        DateTime  @default(now())

  // Stripe
  stripeCustomerId      String?
  stripeSubscriptionId  String?

  // Relations
  detections            Detection[]
  verifications         Verification[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Detection {
  id                String            @id @default(cuid())
  userId            String?
  user              User?             @relation(fields: [userId], references: [id])

  // Text data
  textHash          String            // SHA-256 of full text
  textContent       String            @db.Text // Store full text for ML training
  textPreview       String            // First 500 chars
  wordCount         Int

  // Detection results
  score             Float             // 0.0 to 1.0
  verdict           DetectionVerdict
  confidence        Float             // How confident is the detection

  // Detailed analysis (6 dimensions)
  analysis          Json              // Full breakdown of all scores

  // ML Training Data Collection
  apiProvider       String?           // Which API used (zerogpt, gptzero, heuristic)
  apiRawResponse    Json?             // Raw API response for training
  userFeedback      String?           // User reported if detection was wrong (CORRECT_AI, CORRECT_HUMAN, WRONG)
  userFeedbackAt    DateTime?         // When user provided feedback

  // Verification status
  isVerified        Boolean           @default(false)
  certificateId     String?           @unique

  // Metadata
  ipAddress         String?           // For rate limiting anonymous users
  userAgent         String?

  createdAt         DateTime          @default(now())

  // Relations
  verification      Verification?

  @@index([userId, createdAt])
  @@index([textHash])
  @@index([certificateId])
}

model Verification {
  id                String      @id @default(cuid())
  certificateId     String      @unique  // POC-2025-XXXXXX format

  detectionId       String      @unique
  detection         Detection   @relation(fields: [detectionId], references: [id])

  userId            String?
  user              User?       @relation(fields: [userId], references: [id])

  // Content
  contentHash       String      // SHA-256 hash
  contentPreview    String      // First 500 chars
  title             String?     // Optional title for certificate

  score             Float       // Human likelihood score

  // Blockchain fields (PostgreSQL ledger)
  blockNumber       Int
  prevHash          String      // Hash of previous block
  blockHash         String      // Hash of this block

  // External blockchain anchoring (Phase 2)
  anchored          Boolean     @default(false)
  anchorTxHash      String?     // Base/Ethereum tx hash
  anchorChain       String?     // 'base', 'ethereum'

  verifiedAt        DateTime    @default(now())

  @@index([certificateId])
  @@index([userId, verifiedAt])
}

model ApiUsage {
  id                String      @id @default(cuid())
  userId            String
  endpoint          String
  requestCount      Int         @default(1)
  date              DateTime    @default(now()) @db.Date

  @@unique([userId, endpoint, date])
  @@index([userId, date])
}
